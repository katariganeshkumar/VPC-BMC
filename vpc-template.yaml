AWSTemplateFormatVersion: '2010-09-09'
Description: 'Multi-VPC CloudFormation Template - Creates VPC with IGW, NAT Gateway, Public and Private Subnets'

Parameters:
  # VPC Configuration
  VpcCidr:
    Type: String
    Description: CIDR block for the VPC (e.g., 10.0.0.0/16)
    Default: 10.0.0.0/16
  
  VpcName:
    Type: String
    Description: Name tag for the VPC
    Default: MultiVPC-Instance
  
  # Availability Zones
  AvailabilityZone1:
    Type: AWS::EC2::AvailabilityZone::Name
    Description: First Availability Zone for subnets
    Default: us-east-1a
  
  AvailabilityZone2:
    Type: AWS::EC2::AvailabilityZone::Name
    Description: Second Availability Zone for private subnets
    Default: us-east-1b
  
  # Public Subnet Configuration
  PublicSubnetCidr:
    Type: String
    Description: CIDR block for the public subnet (e.g., 10.0.1.0/24)
    Default: 10.0.1.0/24
  
  # Private Subnet Configuration
  PrivateSubnet1Cidr:
    Type: String
    Description: CIDR block for the first private subnet (e.g., 10.0.2.0/24)
    Default: 10.0.2.0/24
  
  PrivateSubnet2Cidr:
    Type: String
    Description: CIDR block for the second private subnet (e.g., 10.0.3.0/24)
    Default: 10.0.3.0/24
  
  # EC2 Key Pair (temporary for testing)
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 Key Pair name for immediate testing (will transition to SSM)
    Default: ''
  
  # Environment Tag
  Environment:
    Type: String
    Description: Environment name (e.g., dev, staging, prod)
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-VPC'
        - Key: Environment
          Value: !Ref Environment
  
  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-IGW'
        - Key: Environment
          Value: !Ref Environment
  
  # Attach Internet Gateway to VPC
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
  
  # Elastic IP for NAT Gateway
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-NAT-EIP'
        - Key: Environment
          Value: !Ref Environment
  
  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Ref AvailabilityZone1
      CidrBlock: !Ref PublicSubnetCidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Public-Subnet'
        - Key: Environment
          Value: !Ref Environment
        - Key: Type
          Value: Public
  
  # Private Subnet 1
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Ref AvailabilityZone1
      CidrBlock: !Ref PrivateSubnet1Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Private-Subnet-1'
        - Key: Environment
          Value: !Ref Environment
        - Key: Type
          Value: Private
  
  # Private Subnet 2
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Ref AvailabilityZone2
      CidrBlock: !Ref PrivateSubnet2Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Private-Subnet-2'
        - Key: Environment
          Value: !Ref Environment
        - Key: Type
          Value: Private
  
  # NAT Gateway (placed in public subnet)
  NatGateway:
    Type: AWS::EC2::NatGateway
    DependsOn: NatGatewayEIP
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-NAT-Gateway'
        - Key: Environment
          Value: !Ref Environment
  
  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Public-RouteTable'
        - Key: Environment
          Value: !Ref Environment
  
  # Default route for public subnet (0.0.0.0/0 -> IGW)
  PublicDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  
  # Associate Public Subnet with Public Route Table
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable
  
  # Private Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Private-RouteTable'
        - Key: Environment
          Value: !Ref Environment
  
  # Default route for private subnets (0.0.0.0/0 -> NAT Gateway)
  PrivateDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: NatGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway
  
  # Associate Private Subnet 1 with Private Route Table
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable
  
  # Associate Private Subnet 2 with Private Route Table
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable
  
  # Security Group for Public Subnet (SSH access)
  PublicSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${VpcName}-Public-SG'
      GroupDescription: Security group for public subnet instances
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH access from anywhere (temporary for testing)
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP access
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS access
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Public-SG'
        - Key: Environment
          Value: !Ref Environment
  
  # Security Group for Private Subnets
  PrivateSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${VpcName}-Private-SG'
      GroupDescription: Security group for private subnet instances
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref PublicSecurityGroup
          Description: SSH access from public subnet only
        - IpProtocol: -1
          SourceSecurityGroupId: !Ref PublicSecurityGroup
          Description: All traffic from public subnet
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-Private-SG'
        - Key: Environment
          Value: !Ref Environment
  
  # IAM Role for SSM Session Manager
  SSMSessionManagerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${VpcName}-SSM-SessionManager-Role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-SSM-Role'
        - Key: Environment
          Value: !Ref Environment
  
  # Instance Profile for SSM Session Manager
  SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${VpcName}-SSM-InstanceProfile'
      Roles:
        - !Ref SSMSessionManagerRole
      Tags:
        - Key: Name
          Value: !Sub '${VpcName}-SSM-InstanceProfile'
        - Key: Environment
          Value: !Ref Environment

Outputs:
  VpcId:
    Description: VPC ID (dynamic, not hard-coded)
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'
  
  VpcCidr:
    Description: VPC CIDR Block
    Value: !Ref VpcCidr
    Export:
      Name: !Sub '${AWS::StackName}-VPC-CIDR'
  
  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway
    Export:
      Name: !Sub '${AWS::StackName}-IGW-ID'
  
  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-Public-Subnet-ID'
  
  PublicSubnetCidr:
    Description: Public Subnet CIDR Block
    Value: !Ref PublicSubnetCidr
    Export:
      Name: !Sub '${AWS::StackName}-Public-Subnet-CIDR'
  
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-Private-Subnet-1-ID'
  
  PrivateSubnet1Cidr:
    Description: Private Subnet 1 CIDR Block
    Value: !Ref PrivateSubnet1Cidr
    Export:
      Name: !Sub '${AWS::StackName}-Private-Subnet-1-CIDR'
  
  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-Private-Subnet-2-ID'
  
  PrivateSubnet2Cidr:
    Description: Private Subnet 2 CIDR Block
    Value: !Ref PrivateSubnet2Cidr
    Export:
      Name: !Sub '${AWS::StackName}-Private-Subnet-2-CIDR'
  
  NatGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NatGateway
    Export:
      Name: !Sub '${AWS::StackName}-NAT-Gateway-ID'
  
  NatGatewayEIP:
    Description: NAT Gateway Elastic IP Address
    Value: !Ref NatGatewayEIP
    Export:
      Name: !Sub '${AWS::StackName}-NAT-EIP'
  
  PublicRouteTableId:
    Description: Public Route Table ID
    Value: !Ref PublicRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-Public-RouteTable-ID'
  
  PrivateRouteTableId:
    Description: Private Route Table ID
    Value: !Ref PrivateRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-Private-RouteTable-ID'
  
  PublicSecurityGroupId:
    Description: Public Subnet Security Group ID
    Value: !Ref PublicSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-Public-SG-ID'
  
  PrivateSecurityGroupId:
    Description: Private Subnet Security Group ID
    Value: !Ref PrivateSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-Private-SG-ID'
  
  SSMInstanceProfileArn:
    Description: SSM Session Manager Instance Profile ARN
    Value: !GetAtt SSMInstanceProfile.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SSM-InstanceProfile-ARN'
